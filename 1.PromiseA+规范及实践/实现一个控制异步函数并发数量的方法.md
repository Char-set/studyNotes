# å¹¶å‘æŽ§åˆ¶

å¦‚æžœçŽ°åœ¨æœ‰ä¸€æ‰¹ç­‰å¾…å‘èµ·è¯·æ±‚çš„å¼‚æ­¥å‡½æ•°ï¼ˆhttp requestï¼‰ï¼Œè¯¥æ€Žä¹ˆåŽ»å¤„ç†ï¼Ÿ

`ä¸€èˆ¬æ€è·¯ï¼š` å°†æ‰€æœ‰å‡½æ•°å°è£…æˆ `Promise`ï¼Œæ”¾å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶åŽåˆ©ç”¨ `Promise.all` å‘èµ·è¯·æ±‚

```js
    let fns = [fn1, fn2, fn3, fn4];

    Promise.all(fns).then(res => {
        // ...
    })
```

æ›¾ç»è°ƒè¯•è¿‡è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œå¤§æ¦‚ä¸šåŠ¡åœºæ™¯å°±æ˜¯ï¼š

> æœ‰ä¸€ä¸ª`ids` listï¼Œéœ€è¦åˆ†åˆ«è°ƒç”¨è¯¦æƒ…æŽ¥å£åŽ»èŽ·å–æ¯ä¸ªidçš„è¯¦ç»†ç»“æžœ

æœ‰ä¸€å¤©ï¼Œè¿™ä¸ª `ids` é•¿åº¦è¾¾åˆ°äº†ä¸‰ä½æ•°ï¼›ä¸€äº›ä½Žç«¯çš„æ‰‹æœºï¼Œé¡µé¢å°±æ€Žä¹ˆä¹Ÿæ‰“ä¸å¼€äº†...

å¥½å§ï¼Œçº¿ä¸Šæœ‰é—®é¢˜ï¼Œé‚£å°± debugger å‘—ï¼›

è€æ­¥éª¤ï¼šæ‰¾åˆ°è¿™ä¸ªé¡µé¢çš„åœ°å€ ðŸ‘‰  ä½¿ç”¨ `Chrome` æ‰“å¼€é¡µé¢ ðŸ‘‰  F12 å¼€å§‹è°ƒè¯•

è¯´å®žè¯ï¼Œå½“è¿™ä¸ªé¡µé¢çš„åŸºæœ¬Htmlç»“æž„æ¸²æŸ“å®Œæˆï¼Œå¼€å§‹è¿è¡Œ js ä¹‹åŽï¼Œå°±èƒ½æ„Ÿè§‰åˆ°è¿™ä¸ªé¡µé¢çš„ä¸ä¸€èˆ¬ï½žï½ž é‚£ä¸æ˜¯ä¸€èˆ¬çš„å¡

æ‰“å¼€ `NetWork` é¢æ¿ï¼Œå¥½å®¶ä¼™ï¼Œä¸€æ•´é¡µï¼ˆç”šè‡³è¿˜æœ‰ä¸‹ä¸€é¡µï¼‰çš„æŽ¥å£éƒ½åœ¨ pending

ç„¶åŽå°±çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ä»£ç  ðŸ‘‡

```js

    // è¯·æ±‚è¯¦æƒ…ä¿¡æ¯
    function requestDetailInfo(id) {
        fetch(`${BASE_URL}/getDetail?id=${id}`)
        .then((response) => {
            // ...
        })
    }

    const ids = [...ids];
    ids.forEach(id => requestDetailInfo(id));

```

ç€å®žè®©äººæ„Ÿåˆ°æ±—é¢œï¼Œéš¾é“ä¸çŸ¥é“æµè§ˆå™¨å¯¹äºŽåŒåŸŸååŒä¸€æ—¶é—´å‘èµ·çš„è¯·æ±‚æ•°é‡æ˜¯æœ‰[`é™åˆ¶`](https://www.zhihu.com/question/20474326)çš„ä¹ˆï¼Ÿ

> ä¸€èˆ¬å¸¸ç”¨çš„ Chrome æµè§ˆå™¨ï¼Œå¯¹äºŽåŒåŸŸååŒä¸€æ—¶é—´å‘èµ·çš„è¯·æ±‚æ•°é‡é™åˆ¶åœ¨ `6` ä¸ª

## æŽ§åˆ¶ä¸€ä¸‹å‡½æ•°çš„å¹¶å‘æ•°é‡ï¼Ÿ

å¥½å§ï¼Œè¿™ä¹ˆå¸¸è§çš„é—®é¢˜ï¼Œå½“ç„¶è¦å†™ä¸€ä¸ªé€šç”¨æ–¹æ³•æ¥å¤„ç†ä¸€ä¸‹äº†ã€‚

### æ–¹æ¡ˆ1 æŽ§åˆ¶é€šé“æ•°é‡

`æ€è·¯ï¼š` 

  >1ã€ç”¨ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªä¸ºå½“å‰å·²ç»ç»“æŸçš„è¯·æ±‚æ•°é‡ `currentCount`ï¼Œä¸€ä¸ªä¸ºå½“å‰æœ€å¤§å¯ç”¨çš„å¹¶å‘æ•°é‡ `maxCount`ï¼ˆ`é€šé“`ï¼‰
  
  >2ã€å½“ `currentCount` æ¯”éœ€è¦è¯·æ±‚çš„å‡½æ•°åˆ—è¡¨é•¿åº¦å°ï¼Œå¹¶ä¸” `maxCount > 0` æ—¶ï¼Œä»Žå‡½æ•°åˆ—è¡¨ä¸­æ‰¾å‡ºä¸€ä¸ªå¾…è¯·æ±‚çš„ä»»åŠ¡å¼€å§‹æ‰§è¡Œï¼ŒåŒæ—¶å°† `maxCount--`
  
  >3ã€å½“å‡½æ•°æ‰§è¡Œå®ŒæˆåŽï¼Œå°† `é€šé“` å’Œ `currentCount` åˆ†åˆ« + 1

  >4ã€å½“ `currentCount` å’Œ éœ€è¦è¯·æ±‚çš„å‡½æ•°åˆ—è¡¨é•¿åº¦ ç›¸ç­‰çš„æ—¶å€™ï¼Œç»“æŸï¼Œè¿”å›žç»“æžœ


```js
    // å®šä¹‰çŠ¶æ€
    const WAIT_STATE = 'wait';
    const ING_STATE = 'ing';
    const DONE_STATE = 'done';

    /**
     * 
     * @param {Array} list Array[item] item => {options, handle}
     * @param {Number} max æœ€å¤§å¹¶å‘æ•°é‡
     * @param {Function} callback å›žè°ƒå‡½æ•°
     * @returns ans  æŒ‰é¡ºåºè¿”å›žç»“æžœ
     */
    const requestLimit = (list, max = 6, callback) => {
        return new Promise((resolve, reject) => {
            try {
                // å½“å‰å·²ç»ç»“æŸçš„æ•°é‡
                let currentCount = 0;
                // æœ€å¤§é€šé“æ•°é‡
                let maxCount = max;
                const ans = [];
                // é‡æ–°åˆå§‹åŒ–å‡½æ•°åˆ—è¡¨ï¼Œå¹¶åˆå§‹åŒ–å‡½æ•°çŠ¶æ€
                const sequence = [...list].map(item => {
                    item._state = WAIT_STATE;
                    return item;
                });
                // å‡½æ•°åˆ—è¡¨é•¿åº¦
                const len = sequence.length;

                // å¯åŠ¨å‡½æ•°
                const _start = () => {
                    // å½“ `currentCount` æ¯”éœ€è¦è¯·æ±‚çš„å‡½æ•°åˆ—è¡¨é•¿åº¦å°ï¼Œå¹¶ä¸” `maxCount > 0` æ—¶ï¼Œä»Žå‡½æ•°åˆ—è¡¨ä¸­æ‰¾å‡ºä¸€ä¸ªå¾…è¯·æ±‚çš„ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
                    while(currentCount < len && maxCount > 0) {
                        // å°†é€šé“æ•°é‡å‡1
                        maxCount--;
                        // æ‰¾åˆ°ä¸€ä¸ªç­‰å¾…è¯·æ±‚çš„å‡½æ•°
                        let i = sequence.findIndex(item => item._state == WAIT_STATE);
                        if(i == -1) return;

                        // æ›´æ”¹è¿™ä¸ªå‡½æ•°çš„çŠ¶æ€ä¸º ING_STATE
                        sequence[i]._state = ING_STATE;

                        // åˆ©ç”¨ Promise.resolve åŒ…è£…ï¼Œæ‰§è¡Œå‡½æ•°
                        Promise.resolve(sequence[i].handle(sequence[i].options)).then(res => {
                            // æŒ‰é¡ºåºä¿å­˜å‡½æ•°ç»“æžœ
                            ans[i] = res;
                        },err => {
                            // æŒ‰é¡ºåºä¿å­˜å‡½æ•°æŠ¥é”™ä¿¡æ¯
                            ans[i] = err;
                        }).finally(() => {
                            // æ›´æ”¹å‡½æ•°çŠ¶æ€ä¸º DONE_STATE
                            sequence[i]._state = DONE_STATE;

                            // å°† `é€šé“` å’Œ `currentCount` åˆ†åˆ« + 1
                            currentCount++;
                            maxCount++;

                            // å¦‚æžœ å‡½æ•°éƒ½æ‰§è¡Œå®Œæˆ
                            if(currentCount == len) {
                                resolve(ans);
                                typeof callback === 'function' && callback(ans);
                            } else {
                                // å¦åˆ™å†å¯åŠ¨ä¸€æ¬¡å‡½æ•°
                                _start();
                            }
                        });
                    }
                }
                // åˆæ¬¡å¯åŠ¨å‡½æ•°
                _start();
            } catch (e) {
                // è¿”å›žæŠ¥é”™ä¿¡æ¯
                reject(e)
            }
        })

    }
```

`æµ‹è¯•ï¼š`

```js
    const urls =[
        {info:'1', time:2000},
        {info:'2', time:1000},
        {info:'3', time:2000},
        {info:'4', time:2000},
        {info:'5', time:3000},
        {info:'6', time:1000},
        {info:'7', time:2000},
        {info:'8', time:2000},
        {info:'9', time:3000},
        {info:'10', time:1000}
    ]

    function loadImg(url){
        return new Promise((reslove, reject)=>{
            console.log(url.info + '---start')
            setTimeout(()=>{
                console.log(url.info, 'ok!!!')
                reslove(url.info)
            }, url.time)
        })
    }

    // æž„é€ å‡½æ•°åˆ—è¡¨
    const list = urls.map(item => {
        return {
            options: item,
            handle: loadImg
        }
    });

    requestLimit(list, 3, ans => {
        console.log('all is endï¼Œresult is :', ans)
    })

    // è¾“å‡º
    // 1---start
    // 2---start
    // 3---start
    // 2 ok!!!
    // 4---start
    // 1 ok!!!
    // 5---start
    // 3 ok!!!
    // 6---start
    // 4 ok!!!
    // 7---start
    // 6 ok!!!
    // 8---start
    // 5 ok!!!
    // 9---start
    // 7 ok!!!
    // 10---start
    // 8 ok!!!
    // 10 ok!!!
    // 9 ok!!!
    // all is endï¼Œresult is : [
    // '1',  '2', '3',
    // '4',  '5', '6',
    // '7',  '8', '9',
    // '10'
    // ]
```

### æ–¹æ¡ˆ2 åˆ©ç”¨ Promise.race

å¾…æ›´æ–°